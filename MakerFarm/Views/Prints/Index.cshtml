@model IEnumerable<MakerFarm.Models.Print>
@{
    Dictionary<long, MakerFarm.Models.Print> UnstartedCancelEligiblePrints = (Dictionary<long, MakerFarm.Models.Print>)ViewData["UnstartedCancelEligiblePrints"];
    List<MakerFarm.Models.Printer> Printers = (List<MakerFarm.Models.Printer>)ViewData["Printers"];
    Dictionary<long, MakerFarm.Models.Print> Assigned = (Dictionary<long, MakerFarm.Models.Print>)ViewData["Assigned"];
    Dictionary<long, MakerFarm.Models.PrintEvent> PrintingAssignments = (Dictionary<long, MakerFarm.Models.PrintEvent>)ViewData["PrintingAssignments"];
    Dictionary<long, MakerFarm.Models.PrinterStatusLog> PrinterStatus = (Dictionary<long, MakerFarm.Models.PrinterStatusLog>)ViewData["PrinterStatus"];
    int id = (int)ViewData["id"];
}
<h2>@ViewBag.Title</h2>

<p>
    @Html.ActionLink("Past Prints", "Completed", new { id = ViewBag.id })
</p>

<h3>Currently Printing:</h3>
<table class="table">
    <tr>
        <th>
            @Html.DisplayName("Printer")
        </th>
        <th>
            Printer Status
        </th>
        <th>
            Status Update
        </th>
        <th></th>
    </tr>

@foreach (MakerFarm.Models.Printer item in Printers)
        {
    <tr>
        <td><!--Printer Name-->
        @if (User.Identity.IsAuthenticated && (Roles.IsUserInRole("Moderator") || Roles.IsUserInRole("Administrator"))) 
        {
            @Html.ActionLink(item.PrinterName, "Details", "Printers", new { id = item.PrinterId }, null)
        }
        else
        {
            @item.PrinterName
        }    
        </td><!--End Printer Name-->
        <td><!--Printer Status/Username + Print File-->
        <!--Test if Printer is Active-->
        @if (PrintingAssignments.ContainsKey(item.PrinterId))
        {
            if (User.Identity.IsAuthenticated && (Roles.IsUserInRole("Moderator") || Roles.IsUserInRole("Administrator") || User.Identity.Name.Equals(Assigned[PrintingAssignments[item.PrinterId].PrintId].UserName)))
            {<!--Allow Submitter, Moderator and Administrator to look at print details-->
                @Html.ActionLink(string.Concat("User: ", Assigned[PrintingAssignments[item.PrinterId].PrintId].UserName, " | Printing: ", Assigned[PrintingAssignments[item.PrinterId].PrintId].FileName), "Details", new { id = PrintingAssignments[item.PrinterId].PrintId }) 
            }
            else
            {<!--Not the Submitter or elevated user, just display User and File Name-->
                string.Concat("User: ", Assigned[PrintingAssignments[item.PrinterId].PrintId].UserName, " | Printing: ", Assigned[PrintingAssignments[item.PrinterId].PrintId].FileName);
            }
        }
        else
        {
            if (User.Identity.IsAuthenticated && (Roles.IsUserInRole("Moderator") || Roles.IsUserInRole("Administrator")))
            {<!--Allow Submitter, Moderator and Administrator to look at print details-->
                if (PrinterStatus.ContainsKey(item.PrinterId))
                {
                    @Html.ActionLink(PrinterStatus[item.PrinterId].LoggedPrinterStatus.ToString(), "Details", "Printers", new { id = item.PrinterId })
                }
                else
                {
                    @Html.ActionLink("Offline", "Details", "Printers", new { id = item.PrinterId }, null)
                }
            }
            else
            {<!--Not the Submitter or elevated user, just display User and File Name-->
                if (PrinterStatus.ContainsKey(item.PrinterId))
                {<!--If Printer has a status-->
                    @PrinterStatus[item.PrinterId].LoggedPrinterStatus.ToString()
                }
                else
                {<!--If Printer Status is unkown, mark it as down-->
                    <text>Offline</text>
                }
            }
        }
        </td><!--End Printer Status/Username + Print File-->
        <td><!--Status Update-->
            @if (PrinterStatus.ContainsKey(item.PrinterId))
            {
                @PrinterStatus[item.PrinterId].LogEntryDate.ToString()
            }
            else
            {
                DateTime.Now.ToString();
            }
            
        </td><!--End Status Update-->
        <td>
        @if (User.Identity.IsAuthenticated && (Roles.IsUserInRole("Moderator") || Roles.IsUserInRole("Administrator")))
        {
            if (PrintingAssignments.ContainsKey(item.PrinterId))
            {<!--Printer is Active-->
                @Html.ActionLink("Update Status", "Create", "PrintEvents", new { id = PrintingAssignments[item.PrinterId].PrintId }, null)
            }
            else
            {<!--Printer is Not Active-->
                @Html.ActionLink("Update Status", "Create", "PrinterStatusLogs", new { id = item.PrinterId }, null)
            }
            
        }
        </td>
    </tr>
        }
</table>


    <h3>Queue to be Printed in Order:</h3>

    <table class="table">
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.FileName)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.UserName)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.SubmissionTime)
            </th>
            <th></th>
        </tr>

        @foreach (var item in Model)
        {
            <tr>
                <td>
                @if (User.Identity.IsAuthenticated && (Roles.IsUserInRole("Moderator") || Roles.IsUserInRole("Administrator") || User.Identity.Name.Equals(item.UserName)))
                {
                    @Html.ActionLink(item.FileName, "Details", new { id = item.PrintId })   
                }
                else
                {
                    @item.FileName
                }
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.UserName)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.TermsAndConditionsAgreement)
                </td>
                <td>
                    @if (User.Identity.IsAuthenticated && (Roles.IsUserInRole("Moderator") || Roles.IsUserInRole("Administrator")))
                    {
                        @Html.ActionLink("Print/Cancel", "Create", "PrintEvents", new { id = item.PrintId}, null)
                    }
                    else if (User.Identity.IsAuthenticated && User.Identity.Name.Equals(item.UserName) && UnstartedCancelEligiblePrints.ContainsKey(item.PrintId))
                    {
                        @Html.ActionLink("Cancel", "Cancel", new { id = item.PrintId })
                    }
                </td>
            </tr>
        }

    </table>
